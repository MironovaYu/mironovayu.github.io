{% extends "admin/base.html" %}
{% block title %}–û–±–∑–æ—Ä ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block admin_content %}
<div class="admin-page">
    <div class="admin-page__header">
        <div class="admin-page__header-row">
            <div>
                <h1>–û–±–∑–æ—Ä</h1>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Å–∞–π—Ç–∞</p>
            </div>
            <button id="deployBtn" class="admin-btn admin-btn--primary" onclick="startDeploy()">
                üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
            </button>
        </div>
    </div>

    <!-- Deploy Status -->
    <div id="deployPanel" class="admin-deploy" style="display:none;">
        <div class="admin-deploy__header">
            <span id="deployTitle">–ü—É–±–ª–∏–∫–∞—Ü–∏—è...</span>
            <button class="admin-btn admin-btn--sm admin-btn--outline" onclick="document.getElementById('deployPanel').style.display='none'">‚úï</button>
        </div>
        <pre id="deployLog" class="admin-deploy__log"></pre>
    </div>

    <div class="admin-cards">
        <a href="{{ url_for('admin_site') }}" class="admin-card">
            <div class="admin-card__icon">‚öô</div>
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <p>–ò–º—è, —Ä–æ–ª—å, —Å–ª–æ–≥–∞–Ω, —Å—Å—ã–ª–∫–∏</p>
        </a>
        <a href="{{ url_for('admin_index') }}" class="admin-card">
            <div class="admin-card__icon">‚≠ê</div>
            <h3>–ì–ª–∞–≤–Ω–∞—è</h3>
            <p>–ì–µ—Ä–æ–π, –∑–∞–ø—Ä–æ—Å—ã, –ø—Ä–µ–≤—å—é —Å–µ–∫—Ü–∏–π, CTA</p>
        </a>
        <a href="{{ url_for('admin_about') }}" class="admin-card">
            <div class="admin-card__icon">üë§</div>
            <h3>–û–±–æ –º–Ω–µ</h3>
            <p>–ü–æ–¥—Ö–æ–¥, –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è, –ø—Ä–∏–Ω—Ü–∏–ø—ã</p>
        </a>
        <a href="{{ url_for('admin_services') }}" class="admin-card">
            <div class="admin-card__icon">üìã</div>
            <h3>–£—Å–ª—É–≥–∏</h3>
            <p>{{ content.services_page.services|length }} —É—Å–ª—É–≥</p>
        </a>
        <a href="{{ url_for('admin_contact') }}" class="admin-card">
            <div class="admin-card__icon">üí¨</div>
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
            <p>Telegram, –∑–∞–ø–∏—Å—å, –ø—Ä–æ—Ü–µ—Å—Å</p>
        </a>
        <a href="{{ url_for('admin_articles') }}" class="admin-card">
            <div class="admin-card__icon">üìù</div>
            <h3>–°—Ç–∞—Ç—å–∏</h3>
            <p>{{ articles|length }} —Å—Ç–∞—Ç–µ–π</p>
        </a>
        <a href="{{ url_for('admin_announcements') }}" class="admin-card">
            <div class="admin-card__icon">üìÖ</div>
            <h3>–ê–Ω–æ–Ω—Å—ã</h3>
            <p>{{ announcements|length }} –∞–Ω–æ–Ω—Å–æ–≤</p>
        </a>
    </div>
</div>

<script>
function startDeploy() {
    const btn = document.getElementById('deployBtn');
    const panel = document.getElementById('deployPanel');
    const log = document.getElementById('deployLog');
    const title = document.getElementById('deployTitle');

    btn.disabled = true;
    btn.textContent = '‚è≥ –ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
    panel.style.display = 'block';
    log.textContent = '';
    title.textContent = '–ü—É–±–ª–∏–∫–∞—Ü–∏—è...';

    fetch('{{ url_for("admin_deploy") }}', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (!data.ok) {
                log.textContent = data.error;
                btn.disabled = false;
                btn.textContent = 'üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
                return;
            }
            pollStatus();
        })
        .catch(err => {
            log.textContent = '–û—à–∏–±–∫–∞: ' + err;
            btn.disabled = false;
            btn.textContent = 'üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
        });
}

function pollStatus() {
    const btn = document.getElementById('deployBtn');
    const log = document.getElementById('deployLog');
    const title = document.getElementById('deployTitle');

    fetch('{{ url_for("admin_deploy_status") }}')
        .then(r => r.json())
        .then(data => {
            log.textContent = data.log.join('\n');
            log.scrollTop = log.scrollHeight;
            if (data.running) {
                setTimeout(pollStatus, 1000);
            } else {
                btn.disabled = false;
                btn.textContent = 'üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
                if (data.result === 'success') {
                    title.textContent = '‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ';
                } else {
                    title.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏';
                }
            }
        })
        .catch(() => setTimeout(pollStatus, 2000));
}
</script>
{% endblock %}

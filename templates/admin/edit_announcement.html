{% extends "admin/base.html" %}
{% block title %}{% if is_new %}Новый анонс{% else %}Редактирование: {{ announcement.title }}{% endif %} — Админ-панель{% endblock %}

{% block admin_content %}
<div class="admin-page">
    <div class="admin-page__header">
        <h1>{% if is_new %}Новый анонс{% else %}Редактирование анонса{% endif %}</h1>
        <a href="{{ url_for('admin_announcements') }}" class="admin-btn admin-btn--outline admin-btn--sm">← К списку анонсов</a>
    </div>

    <form method="POST" class="admin-form" enctype="multipart/form-data">
        <div class="admin-form__section">
            <div class="admin-field">
                <label for="title">Название</label>
                <input type="text" id="title" name="title" value="{{ announcement.title if announcement else '' }}" required>
            </div>
            <div class="admin-field">
                <label for="slug">Slug (URL)</label>
                <input type="text" id="slug" name="slug" value="{{ announcement.slug if announcement else '' }}" placeholder="Оставьте пустым для автогенерации">
            </div>
        </div>

        <div class="admin-form__section">
            <h3>Дата и место</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="admin-field">
                    <label for="date">Дата</label>
                    <input type="date" id="date" name="date" value="{{ announcement.date if announcement else '' }}" required>
                </div>
                <div class="admin-field">
                    <label for="time">Время</label>
                    <input type="time" id="time" name="time" value="{{ announcement.time if announcement else '' }}">
                </div>
            </div>
            <div class="admin-field">
                <label for="location">Место проведения</label>
                <input type="text" id="location" name="location" value="{{ announcement.location if announcement else '' }}" placeholder="Например: Калуга, ул. Ленина, 10">
            </div>
        </div>

        <div class="admin-form__section">
            <h3>Изображение</h3>
            {% if announcement and announcement.image %}
            <div class="admin-image-preview">
                <img src="{{ url_for('static', filename=announcement.image) }}" alt="Текущее изображение">
                <div class="admin-image-preview__actions">
                    <label class="admin-btn admin-btn--outline admin-btn--sm">
                        Заменить
                        <input type="file" name="image_file" accept="image/*" style="display:none" onchange="previewImage(this)">
                    </label>
                    <button type="button" class="admin-btn admin-btn--danger admin-btn--sm" onclick="removeImage()">Удалить</button>
                    <input type="hidden" name="remove_image" id="removeImage" value="0">
                </div>
            </div>
            {% else %}
            <div class="admin-upload-zone" id="uploadZone">
                <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                <p>Перетащите изображение или нажмите для выбора</p>
                <input type="file" name="image_file" accept="image/*" onchange="previewImage(this)">
            </div>
            {% endif %}
            <div id="imagePreview" style="display:none;" class="admin-image-preview">
                <img id="imagePreviewImg" src="" alt="Предпросмотр">
            </div>
        </div>

        <div class="admin-form__section">
            <div class="admin-field">
                <label>Описание</label>
                <div class="admin-editor-wrap">
                    <div id="editor">{{ announcement.description|safe if announcement else '' }}</div>
                </div>
                <textarea id="description" name="description" style="display:none">{{ announcement.description if announcement else '' }}</textarea>
            </div>
            <div class="admin-field admin-field--checkbox">
                <label>
                    <input type="checkbox" name="published" {% if announcement and announcement.published %}checked{% endif %}>
                    Опубликовать
                </label>
            </div>
        </div>
        <button type="submit" class="admin-btn admin-btn--primary">
            {% if is_new %}Создать{% else %}Сохранить{% endif %}
        </button>
    </form>
</div>

<script>
var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            [{ header: [3, 4, false] }],
            ['bold', 'italic', 'underline'],
            [{ list: 'ordered' }, { list: 'bullet' }],
            ['blockquote', 'link'],
            ['clean']
        ]
    }
});

document.querySelector('.admin-form').addEventListener('submit', function() {
    document.getElementById('description').value = quill.root.innerHTML;
});

function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const prev = document.getElementById('imagePreview');
            const img = document.getElementById('imagePreviewImg');
            img.src = e.target.result;
            prev.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
        const rm = document.getElementById('removeImage');
        if (rm) rm.value = '0';
    }
}

function removeImage() {
    document.getElementById('removeImage').value = '1';
    const previews = document.querySelectorAll('.admin-image-preview');
    previews.forEach(p => p.style.display = 'none');
    const zone = document.getElementById('uploadZone');
    if (!zone) {
        location.reload();
    }
}
</script>
{% endblock %}
